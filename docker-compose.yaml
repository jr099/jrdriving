version: "3.8"

services:
  web-build:
    image: node:20-alpine
    working_dir: /app
    # Monte uniquement le dossier du front (si ton front est dans ./web, adapte le volume et le cd)
    volumes:
      - ./:/app
      - dist_vol:/app/dist
    environment:
      VITE_API_URL: ${VITE_API_URL}
    command: >
      sh -lc "
        if [ -f package.json ]; then
          echo 'üîß Building front...';
          if [ -f package-lock.json ]; then npm ci; else npm install; fi;
          npm run build;
        else
          echo '‚ùå package.json not found at /app'; exit 1;
        fi
      "
    restart: "no"

  web-upload:
    image: alpine:3.20
    depends_on:
      - web-build
    volumes:
      - dist_vol:/upload:ro
    environment:
      HOSTINGER_HOST: ${HOSTINGER_HOST}        # ex: ftp.hostinger.com
      HOSTINGER_USER: ${HOSTINGER_USER}        # user FTP
      HOSTINGER_PASS: ${HOSTINGER_PASS}        # pass FTP
      HOSTINGER_REMOTE_DIR: ${HOSTINGER_REMOTE_DIR:-public_html}
    # Pas d'entrypoint custom ‚Üí une seule commande shell
    command: >
      sh -lc "
        echo 'üì¶ Installing lftp...';
        apk add --no-cache lftp >/dev/null &&
        echo 'üåê Upload via FTPS to $HOSTINGER_HOST...';
        lftp -u \"$HOSTINGER_USER\",\"$HOSTINGER_PASS\" \"$HOSTINGER_HOST\" -e \"
          set ftp:ssl-force true;
          set ftp:ssl-protect-data true;
          set ftp:passive-mode true;
          set net:timeout 20;
          set net:max-retries 2;
          mirror -R --delete --verbose /upload /$HOSTINGER_REMOTE_DIR;
          bye;
        \"
      "
    restart: "no"

volumes:
  dist_vol:
